<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[My Octopress Blog]]></title>
  <link href="http://peterwang.github.com/atom.xml" rel="self"/>
  <link href="http://peterwang.github.com/"/>
  <updated>2013-05-20T23:19:35+02:00</updated>
  <id>http://peterwang.github.com/</id>
  <author>
    <name><![CDATA[Your Name]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Finding memory leaks in long running php script]]></title>
    <link href="http://peterwang.github.com/blog/2013/05/18/finding-memory-leaks-in-long-running-php-script/"/>
    <updated>2013-05-18T18:56:00+02:00</updated>
    <id>http://peterwang.github.com/blog/2013/05/18/finding-memory-leaks-in-long-running-php-script</id>
    <content type="html"><![CDATA[<p>Recently I solved a problem of memory leaks in a long running php script. There were things I&#8217;d like to share, which might be helpful to others.</p>

<p>First of all, I&#8217;ll give some background infomation about the script which leaks memory. The php script is a symfony task, which is running as a consumer of a rabbitmq queue. What this script does is basically fetch available jobs from the rabbitmq queue, and process these jobs, in this case, creating an email from the data of the job and sending the email. The logic of this script is quite simple, but it makes use of a lot of php libraries, which makes it not so easy to find a memory leaks directly.</p>

<p>At the beginning, I looked at the problem and thought, it should not be such a big deal to fix this, then I tried to tackle the problem the quick way, which was proved the wrong way at last. I added some <a href="http://php.net/manual/en/function.memory-get-usage.php">memory_get_usage</a> in some critical functions to collect the memory usage information, unfortunately, such information is not sufficient and can&#8217;t provide any useful information to help me identify which part of the code cause the memory leaks. Adding more memory_get_usage is in fact doing memory profiling manually, which is not feasible and acceptable for me. There should be some tools to do such works automatically, I guessed.</p>

<p>Yes, there is! Then I found a great php extension, <a href="https://github.com/arnaud-lb/php-memory-profiler">php-memprof</a>. This extension is extremely helpful to find memory leaks in php scripts.</p>

<p>To use this php extension, first we need install and enable it, this is pretty simple, just follow the steps in the README, pay attention to the dependencies, make sure that you install those dependencies before you install the php extension.</p>

<p>After installed the extension, we can now do some simple experiments with it to get some ideas how it works.</p>

<p>From the README.md of the project:</p>

<blockquote><p>php-memprof profiles memory usage of PHP scripts, and especially can tell which function has allocated every single byte of memory currently allocated.</p></blockquote>

<p>What does this mean? Let&#8217;s look a simple example,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nx">memprof_enable</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">f1</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$arr</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">f1</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$profile</span> <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nb">print_r</span><span class="p">(</span><span class="nv">$profile</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ll see output like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [memory_size] =&gt; 32</span>
</span><span class='line'><span class="x">    [blocks_count] =&gt; 1</span>
</span><span class='line'><span class="x">    [memory_size_inclusive] =&gt; 32</span>
</span><span class='line'><span class="x">    [blocks_count_inclusive] =&gt; 1</span>
</span><span class='line'><span class="x">    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [f1] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [memory_size] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count] =&gt; 0</span>
</span><span class='line'><span class="x">                    [memory_size_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [range] =&gt; Array</span>
</span><span class='line'><span class="x">                                (</span>
</span><span class='line'><span class="x">                                    [memory_size] =&gt; 0</span>
</span><span class='line'><span class="x">                                    [blocks_count] =&gt; 0</span>
</span><span class='line'><span class="x">                                    [memory_size_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                                    [blocks_count_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                                        (</span>
</span><span class='line'><span class="x">                                        )</span>
</span><span class='line'><span class="x">                                )</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [memprof_dump_array] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [memory_size] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count] =&gt; 0</span>
</span><span class='line'><span class="x">                    [memory_size_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The output of the profiling is pretty straightforward, it was of the same structure as the call stack of the php code executed. The most top level keys give the information of <strong>memory usage</strong> of the php code by the time when <em>memprof_dump_array</em> was called. Here by <strong>memory usage</strong> it means the difference of the memory allocated, for example, in the example above, the value of key <em>memory_size</em> is 32 bytes, it means the memory usage was increased by 32 bytes since the time when <em>memprof_enable</em> was called.</p>

<p>Though there was a huge memory allocated by creating an 1000-elements array inside function <em>f1</em>, but that memory was immediately freed when function <em>f1</em> returns, so it should not be added to memory usage.</p>

<p>From the value of key <em>memory_size_inclusive</em>, which stands for the memory used by both the code itself and code of all the functions it called, we can also come up with the same conclusion, for example, here the value of <em>memory_size_inclusive</em> is also 32 bytes, which means all functions it called didn&#8217;t contributes anything to the memory usage.</p>

<p>Let&#8217;s run this example again with a slight change to the code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nx">memprof_enable</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">f1</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">global</span> <span class="nv">$arr</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$arr</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">f1</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$profile</span> <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nb">print_r</span><span class="p">(</span><span class="nv">$profile</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we add a line in f1:</p>

<blockquote><p>global $arr;</p></blockquote>

<p>The output is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [memory_size] =&gt; 32</span>
</span><span class='line'><span class="x">    [blocks_count] =&gt; 1</span>
</span><span class='line'><span class="x">    [memory_size_inclusive] =&gt; 111403</span>
</span><span class='line'><span class="x">    [blocks_count_inclusive] =&gt; 2005</span>
</span><span class='line'><span class="x">    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [f1] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [memory_size] =&gt; 79371</span>
</span><span class='line'><span class="x">                    [blocks_count] =&gt; 1004</span>
</span><span class='line'><span class="x">                    [memory_size_inclusive] =&gt; 111371</span>
</span><span class='line'><span class="x">                    [blocks_count_inclusive] =&gt; 2004</span>
</span><span class='line'><span class="x">                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [range] =&gt; Array</span>
</span><span class='line'><span class="x">                                (</span>
</span><span class='line'><span class="x">                                    [memory_size] =&gt; 32000</span>
</span><span class='line'><span class="x">                                    [blocks_count] =&gt; 1000</span>
</span><span class='line'><span class="x">                                    [memory_size_inclusive] =&gt; 32000</span>
</span><span class='line'><span class="x">                                    [blocks_count_inclusive] =&gt; 1000</span>
</span><span class='line'><span class="x">                                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                                        (</span>
</span><span class='line'><span class="x">                                        )</span>
</span><span class='line'><span class="x">                                )</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [memprof_dump_array] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [memory_size] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count] =&gt; 0</span>
</span><span class='line'><span class="x">                    [memory_size_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We see a big difference in the profiling output. This time the <em>memory_size_inclusive</em> is much larger than <em>memory_size</em>, the difference is caused by the reference of the $arr variable inside <em>f1</em>, here we made it a global variable, which prevent the PHP GC freed the memory. We can easily see that the code which cause the high memory usage is:</p>

<blockquote><p>INIT_CALL() -> f1() -> range()</p></blockquote>

<p>We just follow the <em>memory_size_inclusive</em> keys which are great than 0 to get this. Yes, it is easy to do this in simple cases. But in a more complicated cse, you will not want to do this manually. I am not going to put a real example here to prove this, instead, I am going to give another simple example to show you how to do this easily.</p>

<p>Let&#8217;s say we have a complicated, long running php script, which leaks memory. How can we make use of php-memprof to quickly find the places that leaks memory? The structure of such php script normally is something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// do some initialization, setup, etc</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// get a job from somewhere</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// process the job;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// do some report, clean up, etc</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// maybe sleep some time;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we need do some changes to add the profiling code, for example,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// enable profiling</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nb">extension_loaded</span><span class="p">(</span><span class="s1">&#39;memprof&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">memprof_enable</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// do some initialization, setup, etc</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// get a job from somewhere</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// process the job;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// do some report, clean up, etc</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// maybe sleep some time;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// dump the profiling result every N runs</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">extension_loaded</span><span class="p">(</span><span class="s1">&#39;memprof&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$count</span> <span class="o">%</span> <span class="nx">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$profile</span>  <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'>            <span class="nv">$filepath</span> <span class="o">=</span> <span class="s1">&#39;profile_&#39;</span> <span class="o">.</span> <span class="nv">$count</span><span class="p">;</span>
</span><span class='line'>            <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$profile</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After some time of running, we got a set of files. If there was no memory leaks, those results should be different only in the value of the key <em>calls</em>, otherwise, we should see the difference in keys like <em>memory_size*</em>, <em>blocks_count*</em>. I wrote a simple function to compare 2 results to filter out the difference which we care about.</p>

<p>This diff function will compare 2 profiling result recursively, give the difference. Here is a example.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">diff</span><span class="p">(</span><span class="nv">$a1</span><span class="p">,</span> <span class="nv">$a2</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$call_path</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;INIT_CALL&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$a1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$a2</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$ms1</span>  <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;memory_size&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;memory_size&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$ms2</span>  <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;memory_size&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;memory_size&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$msi1</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;memory_size_inclusive&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;memory_size_inclusive&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$msi2</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;memory_size_inclusive&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;memory_size_inclusive&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$diff_self</span> <span class="o">=</span> <span class="nv">$ms2</span> <span class="o">-</span> <span class="nv">$ms1</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$diff_incl</span> <span class="o">=</span> <span class="nv">$msi2</span> <span class="o">-</span> <span class="nv">$msi1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nv">$diff_self</span> <span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="nv">$diff_incl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>            <span class="s1">&#39;call_path&#39;</span> <span class="o">=&gt;</span> <span class="nv">$call_path</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;diff_self&#39;</span> <span class="o">=&gt;</span> <span class="nv">$diff_self</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;diff_incl&#39;</span> <span class="o">=&gt;</span> <span class="nv">$diff_incl</span><span class="p">,</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$c1</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;called_functions&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;called_functions&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$c2</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;called_functions&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;called_functions&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$fns</span> <span class="o">=</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nb">array_merge</span><span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$c1</span><span class="p">),</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$c2</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$fns</span> <span class="k">as</span> <span class="nv">$fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$p1</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$c1</span><span class="p">[</span><span class="nv">$fn</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$c1</span><span class="p">[</span><span class="nv">$fn</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$p2</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$c2</span><span class="p">[</span><span class="nv">$fn</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$c2</span><span class="p">[</span><span class="nv">$fn</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">diff</span><span class="p">(</span><span class="nv">$p1</span><span class="p">,</span> <span class="nv">$p2</span><span class="p">,</span> <span class="nv">$out</span><span class="p">,</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$call_path</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$fn</span><span class="p">)));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">bar</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">global</span> <span class="nv">$arr</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$arr</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">foo</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">bar</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">memprof_enable</span><span class="p">();</span>
</span><span class='line'><span class="nv">$o1</span> <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'><span class="nx">foo</span><span class="p">();</span>
</span><span class='line'><span class="nv">$o2</span> <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$out</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'><span class="nx">diff</span><span class="p">(</span><span class="nv">$o1</span><span class="p">,</span> <span class="nv">$o2</span><span class="p">,</span> <span class="nv">$out</span><span class="p">);</span>
</span><span class='line'><span class="nb">print_r</span><span class="p">(</span><span class="nv">$out</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The output is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [0] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [call_path] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; INIT_CALL</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [diff_self] =&gt; 106</span>
</span><span class='line'><span class="x">            [diff_incl] =&gt; 111477</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">    [1] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [call_path] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; INIT_CALL</span>
</span><span class='line'><span class="x">                    [1] =&gt; foo</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [diff_self] =&gt; 0</span>
</span><span class='line'><span class="x">            [diff_incl] =&gt; 111371</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">    [2] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [call_path] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; INIT_CALL</span>
</span><span class='line'><span class="x">                    [1] =&gt; foo</span>
</span><span class='line'><span class="x">                    [2] =&gt; bar</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [diff_self] =&gt; 79371</span>
</span><span class='line'><span class="x">            [diff_incl] =&gt; 111371</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">    [3] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [call_path] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; INIT_CALL</span>
</span><span class='line'><span class="x">                    [1] =&gt; foo</span>
</span><span class='line'><span class="x">                    [2] =&gt; bar</span>
</span><span class='line'><span class="x">                    [3] =&gt; range</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [diff_self] =&gt; 32000</span>
</span><span class='line'><span class="x">            [diff_incl] =&gt; 32000</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We check all the call_path key, we get all the places that leaks memory.</p>

<p>It is pretty simple, isn&#8217;t it?</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello Octopress]]></title>
    <link href="http://peterwang.github.com/blog/2013/01/01/hello-octopress/"/>
    <updated>2013-01-01T20:55:00+01:00</updated>
    <id>http://peterwang.github.com/blog/2013/01/01/hello-octopress</id>
    <content type="html"><![CDATA[
]]></content>
  </entry>
  
</feed>
