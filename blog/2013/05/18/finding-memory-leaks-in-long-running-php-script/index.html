
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Finding memory leaks in long running php script - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="Recently I solved a problem of memory leaks in a long running php script. There were things I&#8217;d like to share, which might be helpful to others &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://peterwang.github.com/blog/2013/05/18/finding-memory-leaks-in-long-running-php-script/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41086637-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>A blogging framework for hackers.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:peterwang.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Finding Memory Leaks in Long Running Php Script</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-18T18:56:00+02:00" pubdate data-updated="true">May 18<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Recently I solved a problem of memory leaks in a long running php script. There were things I&#8217;d like to share, which might be helpful to others.</p>

<p>First of all, I&#8217;ll give some background infomation about the script which leaks memory. The php script is a symfony task, which is running as a consumer of a rabbitmq queue. What this script does is basically fetch available jobs from the rabbitmq queue, and process these jobs, in this case, creating an email from the data of the job and sending the email. The logic of this script is quite simple, but it makes use of a lot of php libraries, which makes it not so easy to find a memory leaks directly.</p>

<p>At the beginning, I looked at the problem and thought, it should not be such a big deal to fix this, then I tried to tackle the problem the quick way, which was proved the wrong way at last. I added some <a href="http://php.net/manual/en/function.memory-get-usage.php">memory_get_usage</a> in some critical functions to collect the memory usage information, unfortunately, such information is not sufficient and can&#8217;t provide any useful information to help me identify which part of the code cause the memory leaks. Adding more memory_get_usage is in fact doing memory profiling manually, which is not feasible and acceptable for me. There should be some tools to do such works automatically, I guessed.</p>

<p>Yes, there is! Then I found a great php extension, <a href="https://github.com/arnaud-lb/php-memory-profiler">php-memprof</a>. This extension is extremely helpful to find memory leaks in php scripts.</p>

<p>To use this php extension, first we need install and enable it, this is pretty simple, just follow the steps in the README, pay attention to the dependencies, make sure that you install those dependencies before you install the php extension.</p>

<p>After installed the extension, we can now do some simple experiments with it to get some ideas how it works.</p>

<p>From the README.md of the project:</p>

<blockquote><p>php-memprof profiles memory usage of PHP scripts, and especially can tell which function has allocated every single byte of memory currently allocated.</p></blockquote>

<p>What does this mean? Let&#8217;s look a simple example,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nx">memprof_enable</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">f1</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nv">$arr</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">f1</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$profile</span> <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nb">print_r</span><span class="p">(</span><span class="nv">$profile</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&#8217;ll see output like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [memory_size] =&gt; 32</span>
</span><span class='line'><span class="x">    [blocks_count] =&gt; 1</span>
</span><span class='line'><span class="x">    [memory_size_inclusive] =&gt; 32</span>
</span><span class='line'><span class="x">    [blocks_count_inclusive] =&gt; 1</span>
</span><span class='line'><span class="x">    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [f1] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [memory_size] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count] =&gt; 0</span>
</span><span class='line'><span class="x">                    [memory_size_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [range] =&gt; Array</span>
</span><span class='line'><span class="x">                                (</span>
</span><span class='line'><span class="x">                                    [memory_size] =&gt; 0</span>
</span><span class='line'><span class="x">                                    [blocks_count] =&gt; 0</span>
</span><span class='line'><span class="x">                                    [memory_size_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                                    [blocks_count_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                                        (</span>
</span><span class='line'><span class="x">                                        )</span>
</span><span class='line'><span class="x">                                )</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [memprof_dump_array] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [memory_size] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count] =&gt; 0</span>
</span><span class='line'><span class="x">                    [memory_size_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The output of the profiling is pretty straightforward, it was of the same structure as the call stack of the php code executed. The most top level keys give the information of <strong>memory usage</strong> of the php code by the time when <em>memprof_dump_array</em> was called. Here by <strong>memory usage</strong> it means the difference of the memory allocated, for example, in the example above, the value of key <em>memory_size</em> is 32 bytes, it means the memory usage was increased by 32 bytes since the time when <em>memprof_enable</em> was called.</p>

<p>Though there was a huge memory allocated by creating an 1000-elements array inside function <em>f1</em>, but that memory was immediately freed when function <em>f1</em> returns, so it should not be added to memory usage.</p>

<p>From the value of key <em>memory_size_inclusive</em>, which stands for the memory used by both the code itself and code of all the functions it called, we can also come up with the same conclusion, for example, here the value of <em>memory_size_inclusive</em> is also 32 bytes, which means all functions it called didn&#8217;t contributes anything to the memory usage.</p>

<p>Let&#8217;s run this example again with a slight change to the code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="nx">memprof_enable</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">f1</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">global</span> <span class="nv">$arr</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$arr</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">f1</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$profile</span> <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nb">print_r</span><span class="p">(</span><span class="nv">$profile</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we add a line in f1:</p>

<blockquote><p>global $arr;</p></blockquote>

<p>The output is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [memory_size] =&gt; 32</span>
</span><span class='line'><span class="x">    [blocks_count] =&gt; 1</span>
</span><span class='line'><span class="x">    [memory_size_inclusive] =&gt; 111403</span>
</span><span class='line'><span class="x">    [blocks_count_inclusive] =&gt; 2005</span>
</span><span class='line'><span class="x">    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [f1] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [memory_size] =&gt; 79371</span>
</span><span class='line'><span class="x">                    [blocks_count] =&gt; 1004</span>
</span><span class='line'><span class="x">                    [memory_size_inclusive] =&gt; 111371</span>
</span><span class='line'><span class="x">                    [blocks_count_inclusive] =&gt; 2004</span>
</span><span class='line'><span class="x">                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                            [range] =&gt; Array</span>
</span><span class='line'><span class="x">                                (</span>
</span><span class='line'><span class="x">                                    [memory_size] =&gt; 32000</span>
</span><span class='line'><span class="x">                                    [blocks_count] =&gt; 1000</span>
</span><span class='line'><span class="x">                                    [memory_size_inclusive] =&gt; 32000</span>
</span><span class='line'><span class="x">                                    [blocks_count_inclusive] =&gt; 1000</span>
</span><span class='line'><span class="x">                                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                                        (</span>
</span><span class='line'><span class="x">                                        )</span>
</span><span class='line'><span class="x">                                )</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [memprof_dump_array] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [memory_size] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count] =&gt; 0</span>
</span><span class='line'><span class="x">                    [memory_size_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [blocks_count_inclusive] =&gt; 0</span>
</span><span class='line'><span class="x">                    [calls] =&gt; 1</span>
</span><span class='line'><span class="x">                    [called_functions] =&gt; Array</span>
</span><span class='line'><span class="x">                        (</span>
</span><span class='line'><span class="x">                        )</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We see a big difference in the profiling output. This time the <em>memory_size_inclusive</em> is much larger than <em>memory_size</em>, the difference is caused by the reference of the $arr variable inside <em>f1</em>, here we made it a global variable, which prevent the PHP GC freed the memory. We can easily see that the code which cause the high memory usage is:</p>

<blockquote><p>INIT_CALL() -> f1() -> range()</p></blockquote>

<p>We just follow the <em>memory_size_inclusive</em> keys which are great than 0 to get this. Yes, it is easy to do this in simple cases. But in a more complicated cse, you will not want to do this manually. I am not going to put a real example here to prove this, instead, I am going to give another simple example to show you how to do this easily.</p>

<p>Let&#8217;s say we have a complicated, long running php script, which leaks memory. How can we make use of php-memprof to quickly find the places that leaks memory? The structure of such php script normally is something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// do some initialization, setup, etc</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// get a job from somewhere</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// process the job;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// do some report, clean up, etc</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// maybe sleep some time;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>First we need do some changes to add the profiling code, for example,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// enable profiling</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nb">extension_loaded</span><span class="p">(</span><span class="s1">&#39;memprof&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">memprof_enable</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// do some initialization, setup, etc</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span><span class="p">(</span><span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// get a job from somewhere</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// process the job;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// do some report, clean up, etc</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// maybe sleep some time;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// dump the profiling result every N runs</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">extension_loaded</span><span class="p">(</span><span class="s1">&#39;memprof&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$count</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nv">$count</span> <span class="o">%</span> <span class="nx">N</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nv">$profile</span>  <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'>            <span class="nv">$filepath</span> <span class="o">=</span> <span class="s1">&#39;profile_&#39;</span> <span class="o">.</span> <span class="nv">$count</span><span class="p">;</span>
</span><span class='line'>            <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$filepath</span><span class="p">,</span> <span class="nb">serialize</span><span class="p">(</span><span class="nv">$profile</span><span class="p">));</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After some time of running, we got a set of files. If there was no memory leaks, those results should be different only in the value of the key <em>calls</em>, otherwise, we should see the difference in keys like <em>memory_size*</em>, <em>blocks_count*</em>. I wrote a simple function to compare 2 results to filter out the difference which we care about.</p>

<p>This diff function will compare 2 profiling result recursively, give the difference. Here is a example.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="cp">&lt;?php</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">diff</span><span class="p">(</span><span class="nv">$a1</span><span class="p">,</span> <span class="nv">$a2</span><span class="p">,</span> <span class="o">&amp;</span><span class="nv">$out</span><span class="p">,</span> <span class="nv">$call_path</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;INIT_CALL&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$a1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="k">empty</span><span class="p">(</span><span class="nv">$a2</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$ms1</span>  <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;memory_size&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;memory_size&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$ms2</span>  <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;memory_size&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;memory_size&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$msi1</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;memory_size_inclusive&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;memory_size_inclusive&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$msi2</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;memory_size_inclusive&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;memory_size_inclusive&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$diff_self</span> <span class="o">=</span> <span class="nv">$ms2</span> <span class="o">-</span> <span class="nv">$ms1</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$diff_incl</span> <span class="o">=</span> <span class="nv">$msi2</span> <span class="o">-</span> <span class="nv">$msi1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nv">$diff_self</span> <span class="o">!=</span><span class="mi">0</span> <span class="o">||</span> <span class="nv">$diff_incl</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$out</span><span class="p">[]</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
</span><span class='line'>            <span class="s1">&#39;call_path&#39;</span> <span class="o">=&gt;</span> <span class="nv">$call_path</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;diff_self&#39;</span> <span class="o">=&gt;</span> <span class="nv">$diff_self</span><span class="p">,</span>
</span><span class='line'>            <span class="s1">&#39;diff_incl&#39;</span> <span class="o">=&gt;</span> <span class="nv">$diff_incl</span><span class="p">,</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$c1</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;called_functions&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a1</span><span class="p">[</span><span class="s1">&#39;called_functions&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$c2</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;called_functions&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$a2</span><span class="p">[</span><span class="s1">&#39;called_functions&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>    <span class="nv">$fns</span> <span class="o">=</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nb">array_merge</span><span class="p">(</span><span class="nb">array_keys</span><span class="p">(</span><span class="nv">$c1</span><span class="p">),</span> <span class="nb">array_keys</span><span class="p">(</span><span class="nv">$c2</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">foreach</span><span class="p">(</span><span class="nv">$fns</span> <span class="k">as</span> <span class="nv">$fn</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nv">$p1</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$c1</span><span class="p">[</span><span class="nv">$fn</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$c1</span><span class="p">[</span><span class="nv">$fn</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nv">$p2</span> <span class="o">=</span> <span class="nb">isset</span><span class="p">(</span><span class="nv">$c2</span><span class="p">[</span><span class="nv">$fn</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$c2</span><span class="p">[</span><span class="nv">$fn</span><span class="p">]</span> <span class="o">:</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">diff</span><span class="p">(</span><span class="nv">$p1</span><span class="p">,</span> <span class="nv">$p2</span><span class="p">,</span> <span class="nv">$out</span><span class="p">,</span> <span class="nb">array_merge</span><span class="p">(</span><span class="nv">$call_path</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$fn</span><span class="p">)));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">bar</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">global</span> <span class="nv">$arr</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$arr</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">foo</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nx">bar</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">memprof_enable</span><span class="p">();</span>
</span><span class='line'><span class="nv">$o1</span> <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'><span class="nx">foo</span><span class="p">();</span>
</span><span class='line'><span class="nv">$o2</span> <span class="o">=</span> <span class="nx">memprof_dump_array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$out</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'><span class="nx">diff</span><span class="p">(</span><span class="nv">$o1</span><span class="p">,</span> <span class="nv">$o2</span><span class="p">,</span> <span class="nv">$out</span><span class="p">);</span>
</span><span class='line'><span class="nb">print_r</span><span class="p">(</span><span class="nv">$out</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The output is:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='php'><span class='line'><span class="x">Array</span>
</span><span class='line'><span class="x">(</span>
</span><span class='line'><span class="x">    [0] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [call_path] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; INIT_CALL</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [diff_self] =&gt; 106</span>
</span><span class='line'><span class="x">            [diff_incl] =&gt; 111477</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">    [1] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [call_path] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; INIT_CALL</span>
</span><span class='line'><span class="x">                    [1] =&gt; foo</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [diff_self] =&gt; 0</span>
</span><span class='line'><span class="x">            [diff_incl] =&gt; 111371</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">    [2] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [call_path] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; INIT_CALL</span>
</span><span class='line'><span class="x">                    [1] =&gt; foo</span>
</span><span class='line'><span class="x">                    [2] =&gt; bar</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [diff_self] =&gt; 79371</span>
</span><span class='line'><span class="x">            [diff_incl] =&gt; 111371</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'>
</span><span class='line'><span class="x">    [3] =&gt; Array</span>
</span><span class='line'><span class="x">        (</span>
</span><span class='line'><span class="x">            [call_path] =&gt; Array</span>
</span><span class='line'><span class="x">                (</span>
</span><span class='line'><span class="x">                    [0] =&gt; INIT_CALL</span>
</span><span class='line'><span class="x">                    [1] =&gt; foo</span>
</span><span class='line'><span class="x">                    [2] =&gt; bar</span>
</span><span class='line'><span class="x">                    [3] =&gt; range</span>
</span><span class='line'><span class="x">                )</span>
</span><span class='line'>
</span><span class='line'><span class="x">            [diff_self] =&gt; 32000</span>
</span><span class='line'><span class="x">            [diff_incl] =&gt; 32000</span>
</span><span class='line'><span class="x">        )</span>
</span><span class='line'><span class="x">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We check all the call_path key, we get all the places that leaks memory.</p>

<p>It is pretty simple, isn&#8217;t it?</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Your Name</span></span>

      








  


<time datetime="2013-05-18T18:56:00+02:00" pubdate data-updated="true">May 18<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://peterwang.github.com/blog/2013/05/18/finding-memory-leaks-in-long-running-php-script/" data-via="" data-counturl="http://peterwang.github.com/blog/2013/05/18/finding-memory-leaks-in-long-running-php-script/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/01/01/hello-octopress/" title="Previous Post: Hello Octopress">&laquo; Hello Octopress</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/05/18/finding-memory-leaks-in-long-running-php-script/">Finding memory leaks in long running php script</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/01/hello-octopress/">Hello Octopress</a>
      </li>
    
  </ul>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'peterwang';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://peterwang.github.com/blog/2013/05/18/finding-memory-leaks-in-long-running-php-script/';
        var disqus_url = 'http://peterwang.github.com/blog/2013/05/18/finding-memory-leaks-in-long-running-php-script/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
